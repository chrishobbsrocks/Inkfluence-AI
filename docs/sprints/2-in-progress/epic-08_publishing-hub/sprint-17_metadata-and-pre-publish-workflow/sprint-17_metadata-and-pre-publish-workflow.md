---
sprint: 17
title: "Metadata and Pre-publish Workflow"
type: fullstack
epic: 8
status: in-progress
created: 2026-02-13T13:13:41Z
started: 2026-02-13T17:48:30Z
completed: null
hours: null
workflow_version: "3.1.0"

---

# Sprint 17: Metadata and Pre-publish Workflow

## Overview

| Field | Value |
|-------|-------|
| Sprint | 17 |
| Title | Metadata and Pre-publish Workflow |
| Type | fullstack |
| Epic | 8 |
| Status | In Progress |
| Created | 2026-02-13 |
| Started | 2026-02-13 |
| Completed | - |

## Goal

Build the pre-publish checklist with real validation, AI-powered metadata generation (description, keywords, category), and an editable metadata card UI for the Publish screen.

## Background

Before publishing, authors need to verify their book is ready (chapters complete, QA passed, cover finalized, metadata filled). The publishing metadata (description, keywords, category, price) should be auto-generated by AI and editable by the user. This sprint implements the backend engine, database schema, and full publish page UI.

## Requirements

### Functional Requirements

- [x] Pre-publish checklist with 4 real validation items
- [x] AI-generated book description (~150 words), keywords (up to 7), and category via Claude tool_use
- [x] All metadata fields editable with save functionality
- [x] "Auto-generated" badge on AI-generated fields
- [x] Database persistence for book metadata (new book_metadata table)
- [x] API endpoint POST /api/metadata/generate with auth and validation
- [x] Server action for saving metadata edits
- [x] Publish page with header, checklist, metadata card, and platform placeholder

### Non-Functional Requirements

- [x] Claude tool_use for structured JSON output
- [x] Temperature 0.3 for consistent metadata generation
- [x] Zod validation on all inputs and Claude responses
- [x] Schema-only (db:push) â€” no Drizzle migrations

## Dependencies

- **Sprints**: Sprint 15 (QA scores for checklist), Sprint 14 (export engine)
- **External**: Anthropic SDK, Drizzle ORM

## Scope

### In Scope

- Pre-publish checklist (chapters, QA, cover, metadata validation)
- Metadata generation engine and API route
- Metadata editing UI (description, keywords, category, price)
- Database schema for book_metadata
- Publish page server component + client wrapper

### Out of Scope

- Publishing platform connections (Sprint 18)
- "Publish to All Selected" button functionality (Sprint 18)
- Cover image generation
- Real publishing API integrations

## Technical Approach

Server component fetches book, chapters, QA analysis, and metadata in parallel to compute checklist state. Client wrapper handles AI generation calls and metadata saves. Claude tool_use generates structured metadata (description, keywords, category) with Zod validation. Metadata stored in `book_metadata` table with auto-generated flags to track which fields were AI-generated vs. user-edited.

## Files Created

| File | Purpose |
|------|---------|
| `src/server/db/schema/book-metadata.ts` | Drizzle table with unique bookId, JSONB keywords, auto-generated flags |
| `src/types/book-metadata.ts` | Types: PrePublishChecklistItem, BookMetadataGenerationResult, EBOOK_CATEGORIES |
| `src/lib/validations/book-metadata.ts` | Zod schemas: metadataGenerateRequest, metadataGenerationResponse, updateBookMetadata |
| `src/lib/ai/prompts/metadata-generation.ts` | Prompt builder + tool_use schema for metadata generation |
| `src/lib/ai/metadata-engine.ts` | generateBookMetadata orchestrator using Claude |
| `src/server/queries/book-metadata.ts` | getBookMetadata with ownership verification |
| `src/server/mutations/book-metadata.ts` | saveGeneratedMetadata, upsertBookMetadata |
| `src/server/actions/book-metadata.ts` | saveBookMetadataAction server action |
| `src/app/api/metadata/generate/route.ts` | POST endpoint with auth, validation, generation, persistence |
| `src/components/publish/pre-publish-checklist.tsx` | 4-item checklist card with completion state and action links |
| `src/components/publish/metadata-card.tsx` | Metadata editing card with description, keywords, category, price |
| `src/components/publish/keyword-input.tsx` | Keyword badge list with add/remove, max 7 |
| `src/components/publish/publish-page-client.tsx` | Client wrapper managing generate/save state |
| `src/components/publish/index.ts` | Barrel export |
| `src/components/ui/textarea.tsx` | shadcn Textarea component |
| `src/components/ui/select.tsx` | shadcn Select component |
| `src/lib/ai/prompts/__tests__/metadata-generation.test.ts` | 16 prompt + tool tests |
| `src/lib/validations/__tests__/book-metadata.test.ts` | 19 validation schema tests |
| `src/tests/metadata-api.test.ts` | 8 API route integration tests |
| `src/components/publish/__tests__/pre-publish-checklist.test.tsx` | 7 checklist component tests |
| `src/components/publish/__tests__/metadata-card.test.tsx` | 15 metadata card component tests |

## Files Modified

| File | Change |
|------|--------|
| `src/lib/ai/prompts/constants.ts` | Added METADATA_MAX_TOKENS (1024), METADATA_TEMPERATURE (0.3) |
| `src/server/db/schema/index.ts` | Added book-metadata export |
| `src/server/db/schema/relations.ts` | Added bookMetadata relation to books, added bookMetadataRelations |
| `src/app/(app)/books/[bookId]/publish/page.tsx` | Rewritten from placeholder to full server component |

## Tasks

### Phase 1: Planning
- [x] Review PRD, wireframes, and Epic 8 context
- [x] Design architecture (tool_use, checklist validation, DB schema)
- [x] Clarify requirements (cover check, db:push, placeholder card, shadcn install)

### Phase 2: Implementation
- [x] Install shadcn Textarea and Select components
- [x] Create database schema and data layer (types, validations, queries, mutations, action)
- [x] Create AI prompt builder and metadata engine
- [x] Create API route
- [x] Create UI components (checklist, metadata card, keyword input, client wrapper)
- [x] Rewrite publish page
- [x] Write tests (65 total: 16 prompt, 19 validation, 8 API, 7 checklist, 15 metadata card)

### Phase 3: Validation
- [x] Run full test suite (636 tests passing, 0 failing)
- [x] Quality review

### Phase 4: Documentation
- [x] Update sprint file

## Test Results

- **Total tests**: 636 passing, 0 failing
- **New tests added**: 65 (prompt: 16, validation: 19, API: 8, component: 22)
- **Duration**: ~6s

## Acceptance Criteria

- [x] Pre-publish checklist shows 4 items with real validation state
- [x] Incomplete items show "Complete" link navigating to relevant page
- [x] AI generates book description, keywords, and category via tool_use
- [x] All metadata fields editable (description, keywords, category, price)
- [x] "Auto-generated" badge visible on AI-generated fields
- [x] Metadata saves to database
- [x] Keywords limited to 7
- [x] Price defaults to $9.99
- [x] UI matches wireframe (stone palette, 2-column grid)
- [x] All 636 tests passing

## Notes

- Source files committed in `5bbd662` (Sprint 16 completion commit), tests in `8b002fb`
- Some source files were picked up by Dev Team 1's Sprint 16 completion commit
- Created: 2026-02-13
