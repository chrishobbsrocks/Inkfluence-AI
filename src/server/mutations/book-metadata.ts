import { db } from "@/server/db";
import { bookMetadata } from "@/server/db/schema/book-metadata";
import type { BookMetadataGenerationResult } from "@/types/book-metadata";
import type { UpdateBookMetadataInput } from "@/lib/validations/book-metadata";

/** Save AI-generated metadata with auto-generated flags */
export async function saveGeneratedMetadata(
  bookId: string,
  result: BookMetadataGenerationResult
) {
  const values = {
    bookId,
    description: result.description,
    keywords: result.keywords,
    category: result.category,
    descriptionAutoGenerated: true,
    keywordsAutoGenerated: true,
    categoryAutoGenerated: true,
  };

  const inserted = await db
    .insert(bookMetadata)
    .values(values)
    .onConflictDoUpdate({
      target: bookMetadata.bookId,
      set: {
        description: result.description,
        keywords: result.keywords,
        category: result.category,
        descriptionAutoGenerated: true,
        keywordsAutoGenerated: true,
        categoryAutoGenerated: true,
      },
    })
    .returning();

  return inserted[0]!;
}

/** Update metadata from user edits */
export async function upsertBookMetadata(
  bookId: string,
  data: UpdateBookMetadataInput
) {
  const inserted = await db
    .insert(bookMetadata)
    .values({ bookId, ...data })
    .onConflictDoUpdate({
      target: bookMetadata.bookId,
      set: data,
    })
    .returning();

  return inserted[0]!;
}
